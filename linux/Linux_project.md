Отчет по восстановлению работоспособности вебсервера


Проблема:
ПМ попросил поднять сервер с проектной документацией, который по непонятным причинам перестал работать. По запросу IP адреса в браузере сервер не отвечает; показывает ошибку wgServer. 

Решение:

По предоставленному адресу подключились к терминалу сервера. 
В первую очередь с помощью комманды  
"service httpd status"
проверили жизнеспособность сервера. 
Статус сервера "Active, running", соответcтвенно исключаем вариант того что сервер попросту не запущен.

На всякий случай перезапускаем сервис httpd с помощью команды
sudo systemctl restart httpd.service 
с правами суперпользователя. 

Сервис работает, но все так же не отвечает в браузере. Возможно проблема в файле настроек LocalSettings.php который может быть ассоциирован с ошибкой wgServer. 
Попытка просмотреть содержимое этого файла с помощью команды "cat"
не увенчалась успехом. Сервер отрапортовал о недостаче свободного места. 
А вот это уже интересно...
Использовали комманду df -h чтобы определить количество свободного места на жестком диске. Ожидаемо увидели что он на 100% занят и осталось всего 20кб свободно. 

На этом этапе решили просканировать файловую систему на наличие файлов, объем которых превышает 100МБ с помощью комманды
sudo find / -type f -size +100M | xargs sudo du -h

В результате этого обнаружили что файл access_log занимает более 7Гб. Слишком много. Учитывая что это учебный проект, файл просто удалили. По идее прежде нужно было бы сделать его бэкап в облаке или на внешнем носителе. 
По непонятной причине система удаляла файл логов очень долго, около 7-10 минут. 
Тем не менее - на жестком диске сервера освободили довольно много места.
Еще раз проанализировав отображаемую в веббраузере ошибку, попросили админа сбросить нам бэкап файла настроек, чтобы скопировать его в директорию /var/www/html/mediawiki/ 

Из соображений безопасности также сохранили старый файл переименовав его в LocalSettings.php.bcp

В результате произведенных манипуляций, вебсайт перестал открываться вообще, но в адресной строке мы заметили любопытную вещь, а именно редирект с первоначального IP адреса на другой. 

На этом этапе мы находились в шаге от решения проблемы. 
Вернувшись к файлу настроек, с помощью приложения VIM, мы заменили IP адрес в строке wgServer на 3.69.175.208

После этого сайт заработал. Цель достигнута.
Однако, оставалось решить также проблему возникновения объемных лог файлов. 
Решение этого вопроса было быстро найдено, и состояло в том, чтобы создать небольшой скрипт, который будет создавать архив логов, очищать оригинальный файл логов, удалять старые архивы, перезапускать Apache, и это всё будет выполняться каждую минуту, поскольку именно таким образом мы настроили кронтаб 
(указав * * * * * и прописав путь к нашему скрипту). 


----------СКРИПТ----------

#!/bin/bash

DATE=$(date "+%Y%m%d-%M")

tar -czvf /home/ec2-user/access_log_archives/"$DATE"_access_log.tar.gz /var/log/httpd/access_log

echo "" > /var/log/httpd/access_log

find /home/ec2-user/access_log_archives/ -name "*.tar.gz" -mmin +3 | xargs rm

systemctl restart httpd.service


Конечно все это применимо к учебному проекту. В реальной жизни для сохранения ресурсов сервера мы не будем создавать архивы и чистить логи ежеминутно. В таком случае уместнее будет настроить скрипт и кронтаб на активацию еженедельно или ежемесячно. В отдельных случаях - ежедневно. 

Выводы:
В процессе восстановления работоспособности сервера мы определили что проблема заключалась в файле настроек APACHE сервера. Возможно оригинальный файл был поврежден, а файл бэкапа полученный от админа редиректил нас на другой IP адрес. Мы прописали правильную айпишку и по дороге также пофиксили проблему переполнения памяти сервера файлом логов, который соотвественно мешал работе с другими файлами, как например проверки файла настроек. 
